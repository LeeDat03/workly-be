<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chat Service - Socket.io Test Client</title>
		<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				height: 100vh;
				display: flex;
				justify-content: center;
				align-items: center;
				padding: 20px;
			}
			.container {
				background: white;
				border-radius: 15px;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
				width: 100%;
				max-width: 1200px;
				height: 90vh;
				display: flex;
				flex-direction: row;
			}
			.sidebar {
				width: 300px;
				border-right: 1px solid #eee;
				display: flex;
				flex-direction: column;
				background: #f9f9f9;
				border-radius: 15px 0 0 15px;
			}
			.sidebar-header {
				padding: 20px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				border-radius: 15px 0 0 0;
			}
			.sidebar-header h2 {
				font-size: 18px;
				margin: 0;
			}
			.online-users {
				flex: 1;
				overflow-y: auto;
				padding: 10px;
			}
			.user-item {
				padding: 12px;
				margin: 5px 0;
				background: white;
				border-radius: 8px;
				cursor: pointer;
				display: flex;
				align-items: center;
				gap: 10px;
				transition: all 0.2s;
			}
			.user-item:hover {
				background: #667eea;
				color: white;
				transform: translateX(5px);
			}
			.user-item.active {
				background: #667eea;
				color: white;
			}
			.user-avatar {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background: linear-gradient(135deg, #667eea, #764ba2);
				display: flex;
				align-items: center;
				justify-content: center;
				color: white;
				font-weight: bold;
			}
			.user-info {
				flex: 1;
			}
			.user-name {
				font-weight: 600;
				font-size: 14px;
			}
			.user-type {
				font-size: 11px;
				opacity: 0.7;
			}
			.online-dot {
				width: 10px;
				height: 10px;
				background: #44ff44;
				border-radius: 50%;
				border: 2px solid white;
			}
			.chat-area {
				flex: 1;
				display: flex;
				flex-direction: column;
			}
			.header {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 20px;
				border-radius: 0 15px 0 0;
			}
			.header h1 {
				font-size: 24px;
				margin-bottom: 10px;
			}
			.status {
				display: flex;
				align-items: center;
				gap: 10px;
			}
			.status-indicator {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				background: #ff4444;
			}
			.status-indicator.connected {
				background: #44ff44;
			}
			.config-section {
				padding: 20px;
				border-bottom: 1px solid #eee;
				display: none;
			}
			.config-section.show {
				display: block;
			}
			.config-section input,
			.config-section select {
				width: 100%;
				padding: 10px;
				margin: 5px 0;
				border: 1px solid #ddd;
				border-radius: 5px;
			}
			.config-section button {
				width: 100%;
				padding: 10px;
				margin-top: 10px;
				background: #667eea;
				color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-size: 16px;
			}
			.config-section button:hover {
				background: #5568d3;
			}
			.config-toggle {
				padding: 10px;
				text-align: center;
				background: #f0f0f0;
				cursor: pointer;
				font-size: 12px;
				color: #666;
			}
			.config-toggle:hover {
				background: #e0e0e0;
			}
			.messages {
				flex: 1;
				overflow-y: auto;
				padding: 20px;
				background: #f5f5f5;
			}
			.message {
				margin: 10px 0;
				padding: 10px 15px;
				border-radius: 8px;
				background: white;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
			}
			.message.sent {
				background: #667eea;
				color: white;
				margin-left: 20%;
			}
			.message.received {
				background: white;
				margin-right: 20%;
			}
			.message-header {
				font-size: 12px;
				opacity: 0.7;
				margin-bottom: 5px;
			}
			.message-content {
				font-size: 14px;
			}
			.input-section {
				padding: 20px;
				border-top: 1px solid #eee;
				display: flex;
				gap: 10px;
			}
			.input-section input {
				flex: 1;
				padding: 10px;
				border: 1px solid #ddd;
				border-radius: 5px;
			}
			.input-section button {
				padding: 10px 20px;
				background: #667eea;
				color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
			}
			.input-section button:hover {
				background: #5568d3;
			}
			.typing-indicator {
				padding: 10px 20px;
				font-size: 12px;
				font-style: italic;
				color: #666;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<!-- Sidebar with online users -->
			<div class="sidebar">
				<div class="sidebar-header">
					<h2>üë• Online Users</h2>
					<div style="font-size: 12px; margin-top: 5px; opacity: 0.9">
						Click on a user to start chatting
					</div>
				</div>
				<div class="config-toggle" onclick="toggleConfig()">
					‚öôÔ∏è Settings
				</div>
				<div class="config-section" id="configSection">
					<input
						type="text"
						id="serverUrl"
						placeholder="Server URL"
						value="http://localhost:3003"
					/>
					<input
						type="text"
						id="userId"
						placeholder="Your User ID"
						value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6InpDcjJQR0JVQUVOWCIsInJvbGUiOiJVU0VSIiwiaWF0IjoxNzYyODcyNjUwLCJleHAiOjE3NzA2NDg2NTB9.UoZZJP9aQlbcDfWiwgOI7mXxwJ_z1p9sLEvv_S1hsF0"
					/>
					<select id="userType">
						<option value="user">User</option>
						<option value="company">Company</option>
					</select>
					<button id="connectBtn">Connect</button>
				</div>
				<div class="online-users" id="onlineUsers">
					<div
						style="
							padding: 20px;
							text-align: center;
							color: #999;
							font-size: 14px;
						"
					>
						Connect to see online users
					</div>
				</div>
			</div>

			<!-- Chat area -->
			<div class="chat-area">
				<div class="header">
					<h1 id="chatTitle">üí¨ Select a user to start chatting</h1>
					<div class="status">
						<div
							class="status-indicator"
							id="statusIndicator"
						></div>
						<span id="statusText">Disconnected</span>
					</div>
				</div>

				<div class="messages" id="messages">
					<div style="padding: 40px; text-align: center; color: #999">
						<div style="font-size: 48px; margin-bottom: 20px">
							üí¨
						</div>
						<div
							style="
								font-size: 18px;
								font-weight: 600;
								margin-bottom: 10px;
							"
						>
							Welcome to Chat Service
						</div>
						<div style="font-size: 14px">
							1. Connect using the settings<br />
							2. Click on an online user<br />
							3. Start chatting!
						</div>
					</div>
				</div>
				<div class="typing-indicator" id="typingIndicator"></div>

				<div class="input-section">
					<input
						type="text"
						id="messageInput"
						placeholder="Type a message..."
						disabled
					/>
					<button id="sendBtn" disabled>Send</button>
				</div>
			</div>
		</div>

		<script>
			let socket = null;
			let isTyping = false;
			let typingTimeout = null;
			let currentConversationId = null;
			let selectedUser = null;
			let onlineUsers = [];

			const statusIndicator = document.getElementById("statusIndicator");
			const statusText = document.getElementById("statusText");
			const messagesDiv = document.getElementById("messages");
			const typingIndicator = document.getElementById("typingIndicator");
			const messageInput = document.getElementById("messageInput");
			const sendBtn = document.getElementById("sendBtn");
			const connectBtn = document.getElementById("connectBtn");
			const onlineUsersDiv = document.getElementById("onlineUsers");
			const chatTitle = document.getElementById("chatTitle");

			// Toggle config section
			function toggleConfig() {
				document
					.getElementById("configSection")
					.classList.toggle("show");
			}

			// Connect to server
			connectBtn.addEventListener("click", () => {
				const serverUrl = document.getElementById("serverUrl").value;
				const userId = document.getElementById("userId").value;
				const userType = document.getElementById("userType").value;

				if (!serverUrl || !userId) {
					alert("Please fill in all fields");
					return;
				}

				// Disconnect if already connected
				if (socket) {
					socket.disconnect();
				}

				// Connect with authentication
				socket = io(serverUrl, {
					auth: {
						token: userId,
					},
				});

				// Connection events
				socket.on("connect", () => {
					statusIndicator.classList.add("connected");
					statusText.textContent = "Connected";
					addSystemMessage("Connected to server");

					// Request online users list
					socket.emit("get_online_users");
				});

				socket.on("disconnect", () => {
					statusIndicator.classList.remove("connected");
					statusText.textContent = "Disconnected";
					messageInput.disabled = true;
					sendBtn.disabled = true;
					onlineUsersDiv.innerHTML =
						'<div style="padding: 20px; text-align: center; color: #999; font-size: 14px;">Disconnected</div>';
					addSystemMessage("Disconnected from server");
				});

				// Online users list
				socket.on("online_users_list", (data) => {
					updateOnlineUsersList(data.users);
				});

				// Chat events
				socket.on("new_message", (data) => {
					addMessage(data.message, false);
				});

				socket.on("user_typing", (data) => {
					if (data.isTyping) {
						typingIndicator.textContent = `User ${data.userId} is typing...`;
					} else {
						typingIndicator.textContent = "";
					}
				});

				socket.on("message_read", (data) => {
					addSystemMessage(`Message read by ${data.userId}`);
				});

				socket.on("user_online", (data) => {
					addSystemMessage(`User ${data.userId} is online`);
				});

				socket.on("user_offline", (data) => {
					addSystemMessage(`User ${data.userId} is offline`);
				});

				socket.on("error", (data) => {
					addSystemMessage(`Error: ${data.message}`, true);
				});

				socket.on("join_conversation_success", (data) => {
					messageInput.disabled = false;
					sendBtn.disabled = false;
					currentConversationId = data.conversationId;
					addSystemMessage(`‚úì Successfully joined conversation`);
				});
			});

			// Update online users list
			function updateOnlineUsersList(users) {
				const currentUserId = document.getElementById("userId").value;
				onlineUsers = users.filter((u) => u.userId !== currentUserId);

				if (onlineUsers.length === 0) {
					onlineUsersDiv.innerHTML =
						'<div style="padding: 20px; text-align: center; color: #999; font-size: 14px;">No other users online</div>';
					return;
				}

				onlineUsersDiv.innerHTML = "";
				onlineUsers.forEach((user) => {
					const userItem = document.createElement("div");
					userItem.className = "user-item";
					userItem.onclick = () => selectUser(user);

					const avatar = document.createElement("div");
					avatar.className = "user-avatar";
					avatar.textContent = user.userId.charAt(0).toUpperCase();

					const userInfo = document.createElement("div");
					userInfo.className = "user-info";

					const userName = document.createElement("div");
					userName.className = "user-name";
					userName.textContent = user.userId;

					const userType = document.createElement("div");
					userType.className = "user-type";
					userType.textContent = user.userType;

					userInfo.appendChild(userName);
					userInfo.appendChild(userType);

					const onlineDot = document.createElement("div");
					onlineDot.className = "online-dot";

					userItem.appendChild(avatar);
					userItem.appendChild(userInfo);
					userItem.appendChild(onlineDot);

					onlineUsersDiv.appendChild(userItem);
				});
			}

			// Select user to chat
			async function selectUser(user) {
				selectedUser = user;

				// Update UI
				document.querySelectorAll(".user-item").forEach((item) => {
					item.classList.remove("active");
				});
				event.target.closest(".user-item").classList.add("active");

				chatTitle.textContent = `üí¨ Chat with ${user.userId}`;
				messagesDiv.innerHTML = "";
				addSystemMessage(
					`Starting conversation with ${user.userId}...`
				);

				// Create or get conversation
				try {
					const serverUrl =
						document.getElementById("serverUrl").value;
					const currentUserId =
						document.getElementById("userId").value;
					const currentUserType =
						document.getElementById("userType").value;

					const response = await fetch(
						`${serverUrl}/api/conversations`,
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								Authorization: currentUserId,
							},
							body: JSON.stringify({
								participantId: user.userId,
								participantType: user.userType,
							}),
						}
					);

					const result = await response.json();

					if (result.success) {
						currentConversationId = result.data._id;

						// Join conversation via socket
						socket.emit("join_conversation", {
							conversationId: currentConversationId,
						});
					} else {
						addSystemMessage(`Error: ${result.message}`, true);
					}
				} catch (error) {
					addSystemMessage(
						`Error creating conversation: ${error.message}`,
						true
					);
				}
			}

			// Send message
			sendBtn.addEventListener("click", sendMessage);
			messageInput.addEventListener("keypress", (e) => {
				if (e.key === "Enter") {
					sendMessage();
				}
			});

			function sendMessage() {
				const content = messageInput.value.trim();

				if (!content || !currentConversationId) return;

				socket.emit("send_message", {
					conversationId: currentConversationId,
					content,
				});

				addMessage(
					{
						content,
						sender: { id: document.getElementById("userId").value },
					},
					true
				);
				messageInput.value = "";

				// Stop typing
				socket.emit("stop_typing", {
					conversationId: currentConversationId,
				});
			}

			// Typing indicator
			messageInput.addEventListener("input", () => {
				if (!currentConversationId) return;

				if (!isTyping) {
					isTyping = true;
					socket.emit("typing", {
						conversationId: currentConversationId,
					});
				}

				clearTimeout(typingTimeout);
				typingTimeout = setTimeout(() => {
					isTyping = false;
					socket.emit("stop_typing", {
						conversationId: currentConversationId,
					});
				}, 1000);
			});

			// Helper functions
			function addMessage(message, isSent) {
				const messageDiv = document.createElement("div");
				messageDiv.className = `message ${
					isSent ? "sent" : "received"
				}`;

				const header = document.createElement("div");
				header.className = "message-header";
				header.textContent = isSent
					? "You"
					: `User ${message.sender.id}`;

				const content = document.createElement("div");
				content.className = "message-content";
				content.textContent = message.content;

				messageDiv.appendChild(header);
				messageDiv.appendChild(content);
				messagesDiv.appendChild(messageDiv);
				messagesDiv.scrollTop = messagesDiv.scrollHeight;
			}

			function addSystemMessage(text, isError = false) {
				const messageDiv = document.createElement("div");
				messageDiv.style.padding = "10px";
				messageDiv.style.textAlign = "center";
				messageDiv.style.fontSize = "12px";
				messageDiv.style.color = isError ? "#ff4444" : "#666";
				messageDiv.style.fontStyle = "italic";
				messageDiv.textContent = text;
				messagesDiv.appendChild(messageDiv);
				messagesDiv.scrollTop = messagesDiv.scrollHeight;
			}
		</script>
	</body>
</html>
